<style>
  /* Custom scrollbar para modal e listas */
  .scrollbar-thin::-webkit-scrollbar {
    width: 8px;
  }
  
  .scrollbar-thin::-webkit-scrollbar-track {
    background: rgba(76, 29, 149, 0.2);
    border-radius: 4px;
  }
  
  .scrollbar-thin::-webkit-scrollbar-thumb {
    background: rgb(124, 58, 237);
    border-radius: 4px;
  }
  
  .scrollbar-thin::-webkit-scrollbar-thumb:hover {
    background: rgb(139, 92, 246);
  }

  /* Melhorar scroll do modal externo */
  #add-movie-modal::-webkit-scrollbar {
    width: 10px;
  }
  
  #add-movie-modal::-webkit-scrollbar-track {
    background: transparent;
  }
  
  #add-movie-modal::-webkit-scrollbar-thumb {
    background: rgba(124, 58, 237, 0.5);
    border-radius: 5px;
  }
  
  #add-movie-modal::-webkit-scrollbar-thumb:hover {
    background: rgba(124, 58, 237, 0.7);
  }

  /* Scrollbar do modal da roleta */
  #movie-roulette-modal .overflow-y-auto::-webkit-scrollbar {
    width: 10px;
  }
  
  #movie-roulette-modal .overflow-y-auto::-webkit-scrollbar-track {
    background: rgba(76, 29, 149, 0.2);
    border-radius: 5px;
  }
  
  #movie-roulette-modal .overflow-y-auto::-webkit-scrollbar-thumb {
    background: rgba(251, 191, 36, 0.5);
    border-radius: 5px;
  }
  
  #movie-roulette-modal .overflow-y-auto::-webkit-scrollbar-thumb:hover {
    background: rgba(251, 191, 36, 0.7);
  }

  /* Scroll suave */
  #add-movie-modal, .scrollbar-thin {
    scroll-behavior: smooth;
  }

  /* Anima√ß√µes da roleta */
  #roulette-carousel .movie-slot {
    animation: none;
  }

  @keyframes slideIn {
    from {
      transform: translateY(-20px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  #roulette-result > * {
    animation: slideIn 0.5s ease-out;
  }
</style>

<div class="container mx-auto px-4 py-8 max-w-7xl">
  <div class="glass rounded-2xl border border-violet-700/30 bg-white/5 p-6 md:p-8">
    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-8">
      <h1 class="page-title text-3xl font-bold bg-gradient-to-r from-violet-400 to-fuchsia-400 bg-clip-text text-transparent">
        üé¨ Nossos Filmes
      </h1>
      <div class="flex flex-wrap gap-2 w-full sm:w-auto">
        <button class="add-movie-trigger flex-1 sm:flex-none px-6 py-2.5 bg-gradient-to-r from-violet-600 to-fuchsia-600 hover:from-violet-700 hover:to-fuchsia-700 text-white rounded-lg font-medium transition-all shadow-lg hover:shadow-violet-500/50 hover:scale-105">
          <svg class="inline-block w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
          Adicionar Filme
        </button>
      </div>
    </div>

    <div class="flex flex-col sm:flex-row items-stretch sm:items-center justify-between gap-3 sm:gap-0 border-b border-violet-700/30 mb-6">
      <div class="flex overflow-x-auto">
        <button id="tab-watched" class="tab-button px-4 sm:px-6 py-2.5 sm:py-3 font-medium text-violet-300 hover:text-violet-100 transition-colors border-b-2 border-violet-500 whitespace-nowrap text-sm sm:text-base">
          J√° assistimos
          <span class="watched-count ml-1.5 sm:ml-2 px-1.5 sm:px-2 py-0.5 bg-violet-600/30 rounded-full text-xs"><%= watchedMovies.length %></span>
        </button>
        <button id="tab-watchlist" class="tab-button px-4 sm:px-6 py-2.5 sm:py-3 font-medium text-violet-500 hover:text-violet-300 transition-colors border-b-2 border-transparent whitespace-nowrap text-sm sm:text-base">
          Queremos assistir
          <span class="watchlist-count ml-1.5 sm:ml-2 px-1.5 sm:px-2 py-0.5 bg-violet-600/20 rounded-full text-xs"><%= watchlistMovies.length %></span>
        </button>
      </div>
      
      <!-- Roleta com texto descritivo -->
      <div class="flex items-center justify-center sm:justify-end gap-2 sm:gap-3 pb-2 sm:pb-0">
        <span class="text-sm font-medium whitespace-nowrap">N√£o sabe o que assistir?</span>
        <button id="open-roulette-btn" class="px-4 py-1 bg-violet-600/20 hover:bg-violet-600/30 text-violet-200 hover:text-violet-100 rounded-lg text-sm font-medium transition-all border border-violet-600/40 hover:border-violet-500/60 flex items-center gap-2 whitespace-nowrap ">
          <span>Roleta</span>
        </button>
      </div>
    </div>

    <div id="content-watched" class="tab-content">
      <% if (watchedMovies.length === 0) { %>
        <%- include('_empty_state', { icon: 'play', title: 'Nenhum filme assistido ainda', description: 'Comece adicionando filmes que voc√™ j√° assistiu juntos', buttonText: 'Adicionar primeiro filme' }) %>
      <% } else { %>
        <div class="grid grid-cols-1 xs:grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3 sm:gap-4">
          <% watchedMovies.forEach(movie => { %>
            <%- include('_movie_card', { movie }) %>
          <% }) %>
        </div>
      <% } %>
    </div>

    <div id="content-watchlist" class="tab-content hidden">
      <% if (watchlistMovies.length === 0) { %>
        <%- include('_empty_state', { icon: 'bookmark', title: 'Lista vazia', description: 'Adicione filmes que voc√™s querem assistir juntos', buttonText: 'Adicionar √† lista' }) %>
      <% } else { %>
        <div class="grid grid-cols-1 xs:grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3 sm:gap-4">
          <% watchlistMovies.forEach(movie => { %>
            <%- include('_movie_card', { movie }) %>
          <% }) %>
        </div>
      <% } %>
    </div>
  </div>
</div>

<%- include('_add_movie_modal', { tmdbConfigured }) %>
<%- include('_movie_roulette_modal') %>

<script>
(function() {
  const tabButtons = document.querySelectorAll(".tab-button");
  const tabContents = document.querySelectorAll(".tab-content");

  tabButtons.forEach((btn, index) => {
    btn.addEventListener("click", () => {
      tabButtons.forEach((b) => {
        b.classList.remove("border-violet-500", "text-violet-100");
        b.classList.add("border-transparent", "text-violet-500");
      });
      tabContents.forEach((c) => c.classList.add("hidden"));
      
      btn.classList.remove("border-transparent", "text-violet-500");
      btn.classList.add("border-violet-500", "text-violet-100");
      tabContents[index].classList.remove("hidden");
    });
  });

  // Event delegation para avalia√ß√µes de filmes
  document.addEventListener("click", async (e) => {
    const starBtn = e.target.closest(".star-btn");
    if (!starBtn) return;

    const rating = parseInt(starBtn.dataset.rating);
    const movieId = starBtn.dataset.movieId;

    if (!rating || !movieId) return;

    try {
      // Buscar o CSRF token da meta tag
      const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || '';
      
      const response = await fetch(`/movies/${movieId}`, {
        method: "PUT",
        headers: { 
          "Content-Type": "application/json",
          "X-CSRF-Token": csrfToken
        },
        body: JSON.stringify({ rating }),
      });

      if (!response.ok) throw new Error("Erro ao avaliar filme");

      const data = await response.json();
      
      if (data.success) {
        // Atualizar UI sem reload da p√°gina
        updateStarsDisplay(movieId, rating, true);
        
        // Mostrar toast de sucesso
        if (window.showToast) {
          window.showToast(`Avalia√ß√£o de ${rating} estrela${rating > 1 ? 's' : ''} salva!`);
        }
      } else {
        throw new Error(data.error || "Erro ao avaliar filme");
      }
    } catch (error) {
      console.error("Erro:", error);
      window.showToast(error.message || "Erro ao avaliar filme", "error");
    }
  });

  // Fun√ß√£o para atualizar a exibi√ß√£o das estrelas
  function updateStarsDisplay(movieId, rating, isCurrentUser) {
    // Encontrar todos os bot√µes de estrela deste filme
    const starButtons = document.querySelectorAll(`button.star-btn[data-movie-id="${movieId}"]`);
    
    starButtons.forEach((btn) => {
      const starRating = parseInt(btn.dataset.rating);
      const star = btn.querySelector('svg');
      
      if (!star) return;

      if (starRating <= rating) {
        // Estrela preenchida
        star.classList.remove('text-violet-600');
        star.classList.add('text-fuchsia-400', 'fill-fuchsia-400');
        star.setAttribute('fill', 'currentColor');
      } else {
        // Estrela vazia
        star.classList.remove('text-fuchsia-400', 'fill-fuchsia-400');
        star.classList.add('text-violet-600');
        star.setAttribute('fill', 'none');
      }
    });

    // Atualizar texto de instru√ß√£o no card
    const movieCard = document.querySelector(`.movie-card[data-movie-id="${movieId}"]`);
    if (movieCard) {
      const instructionSpan = movieCard.querySelector('.text-\\[10px\\].text-violet-400');
      if (instructionSpan) {
        instructionSpan.textContent = 'Clique para alterar';
      }
    }
  }

  document.querySelectorAll(".add-movie-trigger").forEach((btn) => {
    btn.addEventListener("click", () => {
      if (window.openAddMovieModal) {
        window.openAddMovieModal();
      }
    });
  });

  window.showToast = function (message, type = "success") {
    const toast = document.createElement("div");
    toast.className = `fixed bottom-6 right-6 px-6 py-3 rounded-lg shadow-lg text-white font-medium transition-all duration-300 z-50 ${type === "error" ? "bg-red-500" : "bg-green-500"}`;
    toast.textContent = message;
    toast.style.opacity = "0";
    toast.style.transform = "translateY(20px)";
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.style.opacity = "1";
      toast.style.transform = "translateY(0)";
    }, 10);
    
    setTimeout(() => {
      toast.style.opacity = "0";
      toast.style.transform = "translateY(20px)";
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  };

  // ==================== ROLETA DE FILMES ====================
  const watchlistMovies = <%- JSON.stringify(watchlistMovies) %>;
  const rouletteModal = document.getElementById('movie-roulette-modal');
  const rouletteModalContent = document.getElementById('roulette-modal-content');
  const rouletteSelection = document.getElementById('roulette-selection');
  const rouletteSpinner = document.getElementById('roulette-spinner');
  let selectedMovies = [];
  let rouletteInterval = null;
  let animationFrameId = null; // Para cancelar a anima√ß√£o

  document.getElementById('open-roulette-btn')?.addEventListener('click', () => {
    if (watchlistMovies.length === 0) {
      window.showToast('Adicione filmes √† lista "Queremos assistir" primeiro!', 'error');
      return;
    }
    openRouletteModal();
  });

  function openRouletteModal() {
    // Resetar estado completamente
    selectedMovies = [...watchlistMovies];
    rouletteSelection.classList.remove('hidden');
    rouletteSpinner.classList.add('hidden');
    document.getElementById('roulette-result').classList.add('hidden');
    
    // Garantir que o bot√£o de girar est√° vis√≠vel
    const spinBtn = document.getElementById('spin-btn-selection');
    if (spinBtn) {
      spinBtn.classList.remove('hidden');
      spinBtn.disabled = false;
    }
    
    // Renderizar lista de filmes
    const moviesList = document.getElementById('roulette-movies-list');
    moviesList.innerHTML = watchlistMovies.map(movie => `
      <label class="flex items-center gap-2 p-2 rounded bg-violet-900/20 border border-violet-700/30 hover:border-violet-600 cursor-pointer transition">
        <input type="checkbox" checked class="roulette-checkbox w-4 h-4 accent-fuchsia-500" data-movie-id="${movie.id}">
        <span class="text-sm text-violet-200 line-clamp-1">${movie.title}</span>
      </label>
    `).join('');

    updateSelectedCount();
    
    rouletteModal.classList.remove('hidden');
    setTimeout(() => {
      rouletteModal.style.opacity = '1';
      rouletteModalContent.style.transform = 'scale(1)';
    }, 10);
  }

  function closeRouletteModal() {
    rouletteModal.style.opacity = '0';
    rouletteModalContent.style.transform = 'scale(0.9)';
    
    // Cancelar anima√ß√£o em andamento
    if (animationFrameId) {
      cancelAnimationFrame(animationFrameId);
      animationFrameId = null;
      console.log('üõë Anima√ß√£o cancelada ao fechar modal');
    }
    
    if (rouletteInterval) clearInterval(rouletteInterval);
    
    // Resetar estado ao fechar
    setTimeout(() => {
      rouletteModal.classList.add('hidden');
      
      // Resetar visualiza√ß√µes
      rouletteSelection.classList.remove('hidden');
      rouletteSpinner.classList.add('hidden');
      
      // Limpar resultado
      const resultDiv = document.getElementById('roulette-result');
      resultDiv.classList.add('hidden');
      resultDiv.innerHTML = '';
      resultDiv.style.opacity = '1'; // Resetar opacity
      
      // Resetar slot machine wrapper (estilos inline)
      const slotMachineWrapper = document.getElementById('slot-machine-wrapper');
      if (slotMachineWrapper) {
        slotMachineWrapper.style.display = 'block';
        slotMachineWrapper.style.opacity = '1';
        slotMachineWrapper.style.maxHeight = 'none';
        slotMachineWrapper.style.padding = '';
        slotMachineWrapper.style.marginTop = '';
        slotMachineWrapper.style.marginBottom = '';
        slotMachineWrapper.style.border = '';
        slotMachineWrapper.style.transition = '';
      }
      
      // Limpar carrossel
      const carousel = document.getElementById('roulette-carousel');
      if (carousel) {
        carousel.innerHTML = '';
        carousel.style.transform = 'translateY(0px)';
        carousel.style.transition = '';
      }
      
      // Garantir que o bot√£o esteja vis√≠vel para pr√≥xima vez
      const spinBtn = document.getElementById('spin-btn-selection');
      if (spinBtn) {
        spinBtn.classList.remove('hidden');
      }
    }, 300);
  }

  document.getElementById('close-roulette-btn')?.addEventListener('click', closeRouletteModal);

  // Fechar modal ao clicar fora (no backdrop)
  rouletteModal?.addEventListener('click', (e) => {
    if (e.target === rouletteModal) {
      closeRouletteModal();
    }
  });

  document.getElementById('select-all-btn')?.addEventListener('click', () => {
    document.querySelectorAll('.roulette-checkbox').forEach(cb => cb.checked = true);
    updateSelectedCount();
  });

  document.getElementById('deselect-all-btn')?.addEventListener('click', () => {
    document.querySelectorAll('.roulette-checkbox').forEach(cb => cb.checked = false);
    updateSelectedCount();
  });

  document.addEventListener('change', (e) => {
    if (e.target.classList.contains('roulette-checkbox')) {
      updateSelectedCount();
    }
  });

  function updateSelectedCount() {
    const checked = document.querySelectorAll('.roulette-checkbox:checked');
    selectedMovies = Array.from(checked).map(cb => {
      const id = parseInt(cb.dataset.movieId);
      return watchlistMovies.find(m => m.id === id);
    }).filter(Boolean);
    document.getElementById('selected-count').textContent = selectedMovies.length;
    document.getElementById('spin-btn-selection').disabled = selectedMovies.length === 0;
  }

  document.getElementById('spin-btn-selection')?.addEventListener('click', prepareRoulette);

  function prepareRoulette() {
    console.log('prepareRoulette called, selectedMovies:', selectedMovies);
    if (selectedMovies.length === 0) {
      console.log('No movies selected!');
      return;
    }

    // Esconder sele√ß√£o, preparar spinner
    rouletteSelection.classList.add('hidden');
    rouletteSpinner.classList.remove('hidden');
    document.getElementById('spin-btn-selection').classList.add('hidden');
    document.getElementById('roulette-result').classList.add('hidden');

    // Criar carrossel com filmes repetidos para efeito infinito
    const carousel = document.getElementById('roulette-carousel');
    console.log('carousel element:', carousel);
    
    // SIMPLIFICADO: Apenas 10 repeti√ß√µes (suficiente para boa anima√ß√£o)
    const repeatCount = 10;
    const allMovies = [];
    
    for (let i = 0; i < repeatCount; i++) {
      allMovies.push(...selectedMovies);
    }
    
    console.log('allMovies count:', allMovies.length);

    // Renderizar todos os filmes no carrossel
    // IMPORTANTE: SEM MARGIN (my-2 removido) para alinhamento perfeito!
    carousel.innerHTML = allMovies.map(movie => `
      <div class="movie-slot flex items-center gap-2 sm:gap-3 p-2 sm:p-3 bg-violet-900/80 rounded-lg border-2 border-violet-600/50 backdrop-blur-sm" style="height: 144px; min-height: 144px;">
        <div class="w-16 sm:w-20 h-24 sm:h-28 flex-shrink-0 rounded overflow-hidden bg-violet-950/50 border border-violet-700">
          ${movie.poster_url ? 
            `<img src="${movie.poster_url}" alt="${movie.title}" class="w-full h-full object-cover">` :
            `<div class="w-full h-full flex items-center justify-center">
              <svg class="w-6 h-6 sm:w-8 sm:h-8 text-violet-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z" />
              </svg>
            </div>`
          }
        </div>
        <div class="flex-1 min-w-0">
          <h4 class="text-base sm:text-lg font-bold text-white drop-shadow-lg line-clamp-2">${movie.title}</h4>
          <p class="text-xs sm:text-sm text-violet-200 font-medium">${movie.year || ''}</p>
        </div>
      </div>
    `).join('');
    
    console.log('carousel HTML rendered, length:', carousel.innerHTML.length);
    console.log('carousel children count:', carousel.children.length);
    console.log('Total height estimate:', allMovies.length * 144, 'px');

    // Escolher filme vencedor (entre os filmes originais)
    const winnerIndex = Math.floor(Math.random() * selectedMovies.length);
    const winner = selectedMovies[winnerIndex];
    console.log('Winner selected:', winner.title, 'at index', winnerIndex);

    // L√ìGICA SIMPLIFICADA DE POSICIONAMENTO
    const slotHeight = 144; // altura EXATA de cada slot (sem margin)
    const viewportHeight = 432; // altura da janela (3 slots exatos)
    
    // Posi√ß√£o inicial: come√ßar com o filme no √≠ndice 1 centralizado
    // Para centralizar, o topo do slot deve estar em: (432/2) - (144/2) = 216 - 72 = 144px
    // translateY = -(√≠ndice √ó 144) + 144
    const initialFilmIndex = 1;
    const startPosition = -(initialFilmIndex * slotHeight) + (viewportHeight / 2) - (slotHeight / 2);
    
    // Posi√ß√£o final: vencedor no meio do carousel (repeti√ß√£o 5 de 10)
    const middleRepetition = Math.floor(repeatCount / 2);
    const finalFilmIndex = (middleRepetition * selectedMovies.length) + winnerIndex;
    const finalPosition = -(finalFilmIndex * slotHeight) + (viewportHeight / 2) - (slotHeight / 2);
    
    const totalCarouselHeight = allMovies.length * slotHeight;
    const distanceToTravel = Math.abs(finalPosition - startPosition);
    
    console.log('=== SIMPLIFIED ROULETTE SETUP ===');
    console.log('Total films:', allMovies.length);
    console.log('Carousel height:', totalCarouselHeight, 'px');
    console.log('Slot height:', slotHeight, 'px (EXACT, no margin)');
    console.log('Viewport height:', viewportHeight, 'px (exactly 3 slots)');
    console.log('Initial film index:', initialFilmIndex);
    console.log('Start position:', startPosition, 'px');
    console.log('Final film index:', finalFilmIndex, '(' + winner.title + ')');
    console.log('Final position:', finalPosition, 'px');
    console.log('Distance to travel:', distanceToTravel, 'px');

    // Posicionar carousel na posi√ß√£o inicial
    carousel.style.transform = `translateY(${startPosition}px)`;
    carousel.style.transition = 'none';
    
    console.log('‚úÖ Roulette ready! Should show 3 films perfectly aligned.');
    console.log('   Film 1 (top): partially visible');
    console.log('   Film 2 (middle): CENTERED in yellow box ‚≠ê');
    console.log('   Film 3 (bottom): partially visible');
    console.log('üé≤ Starting animation automatically in 0.5s...');
    
    // Iniciar anima√ß√£o automaticamente ap√≥s um pequeno delay
    setTimeout(() => {
      console.log('üé≤ SPINNING from:', startPosition, 'to:', finalPosition);
      const centerOffset = (viewportHeight / 2) - (slotHeight / 2);
      animateSlotMachine(carousel, startPosition, finalPosition, winner, centerOffset, slotHeight, viewportHeight);
    }, 500); // 500ms de delay para dar tempo de ver os filmes iniciais
  }

  function animateSlotMachine(carousel, startPosition, finalPosition, winner, centerOffset, slotHeight, viewportHeight) {
    console.log('üé¨ === ANIMATION START ===');
    console.log('From:', startPosition, 'px ‚Üí To:', finalPosition, 'px');
    console.log('Distance:', Math.abs(finalPosition - startPosition), 'px');
    
    const totalDistance = Math.abs(finalPosition - startPosition);
    let currentPosition = startPosition;
    let frame = 0;
    const totalFrames = 420; // 7 segundos a 60fps
    
    function animate() {
      frame++;
      const progress = frame / totalFrames;
      
      // Curva de easing: acelera√ß√£o inicial, velocidade constante, desacelera√ß√£o suave
      let easedProgress;
      if (progress < 0.2) {
        // Primeiros 20%: acelera√ß√£o quadr√°tica
        easedProgress = progress * progress * 2.5;
      } else if (progress < 0.7) {
        // 20-70%: velocidade linear constante
        const adjustedProgress = (progress - 0.2) / 0.5;
        easedProgress = 0.1 + (adjustedProgress * 0.6);
      } else {
        // √öltimos 30%: desacelera√ß√£o c√∫bica suave
        const adjustedProgress = (progress - 0.7) / 0.3;
        const decel = 1 - Math.pow(1 - adjustedProgress, 3);
        easedProgress = 0.7 + (decel * 0.3);
      }
      
      // Calcular posi√ß√£o atual
      const targetPosition = startPosition + (totalDistance * easedProgress * -1);
      currentPosition = targetPosition;
      
      carousel.style.transform = `translateY(${currentPosition}px)`;
      carousel.style.transition = 'none';
      
      // Log a cada 60 frames (1 segundo)
      if (frame % 60 === 0) {
        console.log(`‚è±Ô∏è ${(frame/60).toFixed(0)}s: ${(progress*100).toFixed(0)}% complete, at ${currentPosition.toFixed(0)}px`);
      }
      
      // Continuar ou parar
      if (frame < totalFrames) {
        animationFrameId = requestAnimationFrame(animate);
      } else {
        animationFrameId = null; // Limpar quando terminar
        // Anima√ß√£o completa
        console.log('üèÅ === ANIMATION END ===');
        console.log('Final position:', currentPosition.toFixed(2), 'px');
        console.log('Target was:', finalPosition, 'px');
        console.log('Difference:', Math.abs(currentPosition - finalPosition).toFixed(2), 'px');
        console.log('Winner should be centered in yellow box! ‚≠ê');
        
        carousel.style.transform = `translateY(${finalPosition}px)`;
        carousel.style.transition = 'transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1)';
        
        // Efeito de "bounce" ao parar
        setTimeout(() => {
          carousel.style.transform = `translateY(${finalPosition + 30}px)`;
          setTimeout(() => {
            carousel.style.transform = `translateY(${finalPosition}px)`;
            console.log('Animation complete, showing result');
            
            // Mostrar resultado (mas ainda invis√≠vel)
            const resultDiv = document.getElementById('roulette-result');
            showRouletteResult(winner);
            resultDiv.style.opacity = '0';
            resultDiv.style.transition = 'opacity 0.5s ease-in';
            
            // Ap√≥s 500ms: fade out da roleta e fade in do resultado simultaneamente
            setTimeout(() => {
              const slotMachineWrapper = document.getElementById('slot-machine-wrapper');
              
              // Fade in do resultado
              resultDiv.style.opacity = '1';
              
              // Fade out da roleta
              if (slotMachineWrapper) {
                slotMachineWrapper.style.transition = 'opacity 0.5s ease-out, max-height 0.5s ease-out, margin 0.5s ease-out, padding 0.5s ease-out';
                slotMachineWrapper.style.opacity = '0';
                
                // Ap√≥s o fade, colapsar o espa√ßo
                setTimeout(() => {
                  slotMachineWrapper.style.maxHeight = '0';
                  slotMachineWrapper.style.padding = '0';
                  slotMachineWrapper.style.marginTop = '0';
                  slotMachineWrapper.style.marginBottom = '0';
                  slotMachineWrapper.style.border = 'none';
                  
                  setTimeout(() => {
                    slotMachineWrapper.style.display = 'none';
                  }, 500);
                }, 500);
              }
            }, 500);
          }, 200);
        }, 150);
      }
    }

    animationFrameId = requestAnimationFrame(animate);
  }

  function showRouletteResult(movie) {
    // Efeitos sonoros visuais
    const resultDiv = document.getElementById('roulette-result');
    
    setTimeout(() => {
      resultDiv.innerHTML = `
        <div class="text-5xl sm:text-7xl mb-4 animate-bounce">üéâ</div>
        <h3 class="text-2xl sm:text-3xl font-bold text-yellow-400 mb-3 animate-pulse">Filme Escolhido!</h3>
        <p class="text-sm sm:text-base text-violet-300 mb-4 sm:mb-6">A roleta decidiu que voc√™s v√£o assistir:</p>
        <div class="bg-gradient-to-br from-violet-950/80 to-fuchsia-950/80 rounded-xl p-4 sm:p-6 border-2 border-yellow-400/50 shadow-2xl shadow-yellow-500/30 transform hover:scale-105 transition-all">
          <div class="flex flex-col sm:flex-row items-center justify-center gap-3 sm:gap-4 mb-4">
            ${movie.poster_url ? 
              `<img src="${movie.poster_url}" alt="${movie.title}" class="w-20 h-30 sm:w-24 sm:h-36 object-cover rounded-lg shadow-lg">` :
              ''
            }
            <div class="text-center sm:text-left">
              <h4 class="text-2xl sm:text-4xl font-bold text-yellow-300 mb-2">${movie.title}</h4>
              <p class="text-lg sm:text-2xl text-violet-200">${movie.year ? `(${movie.year})` : ''}</p>
            </div>
          </div>
          <div class="flex justify-center gap-2 mt-4">
            <span class="text-2xl sm:text-3xl">üçø</span>
            <span class="text-2xl sm:text-3xl">üé¨</span>
            <span class="text-2xl sm:text-3xl">‚ù§Ô∏è</span>
          </div>
        </div>
        
        <!-- Bot√£o Girar Novamente dentro do resultado -->
        <button
          id="spin-again-btn"
          class="mt-4 sm:mt-6 px-6 sm:px-8 py-2.5 sm:py-3 bg-violet-600 hover:bg-violet-700 text-white text-sm sm:text-base font-semibold rounded-lg transition-all shadow-lg hover:scale-105"
        >
          üîÑ Girar Novamente
        </button>
      `;
      
      resultDiv.classList.remove('hidden');
      
      // Adicionar event listener para o novo bot√£o
      document.getElementById('spin-again-btn')?.addEventListener('click', () => {
        console.log('üîÑ Girar novamente com os mesmos filmes:', selectedMovies);
        
        // Fade out do resultado
        const resultDiv = document.getElementById('roulette-result');
        resultDiv.style.opacity = '0';
        
        setTimeout(() => {
          // Limpar o resultado
          resultDiv.classList.add('hidden');
          resultDiv.innerHTML = '';
          resultDiv.style.opacity = '1';
          
          // Mostrar o wrapper da slot machine novamente
          const slotMachineWrapper = document.getElementById('slot-machine-wrapper');
          if (slotMachineWrapper) {
            slotMachineWrapper.style.display = 'block';
            slotMachineWrapper.style.maxHeight = 'none';
            slotMachineWrapper.style.padding = '';
            slotMachineWrapper.style.marginTop = '';
            slotMachineWrapper.style.marginBottom = '';
            slotMachineWrapper.style.border = '';
            
            // Fade in do wrapper
            setTimeout(() => {
              slotMachineWrapper.style.opacity = '1';
            }, 50);
          }
          
          // Limpar o carrossel
          const carousel = document.getElementById('roulette-carousel');
          carousel.innerHTML = '';
          carousel.style.transform = 'translateY(0px)';
          
          // Chamar prepareRoulette novamente com os mesmos filmes selecionados
          prepareRoulette();
        }, 500);
      });
      
      // Confetti effect (emoji rain)
      createConfetti();
    }, 800);
  }

  function createConfetti() {
    const emojis = ['üéâ', 'üéä', '‚≠ê', '‚ú®', 'üé¨', 'üçø', '‚ù§Ô∏è', 'üíï'];
    const container = document.getElementById('roulette-spinner');
    
    for (let i = 0; i < 30; i++) {
      setTimeout(() => {
        const confetti = document.createElement('div');
        confetti.textContent = emojis[Math.floor(Math.random() * emojis.length)];
        confetti.style.position = 'absolute';
        // Limitar entre 10% e 90% para evitar que saia das bordas
        confetti.style.left = (Math.random() * 80 + 10) + '%';
        confetti.style.top = '-50px';
        confetti.style.fontSize = Math.random() * 20 + 20 + 'px';
        confetti.style.opacity = '0';
        confetti.style.transition = 'all 3s ease-out';
        confetti.style.pointerEvents = 'none';
        confetti.style.zIndex = '30';
        
        container.appendChild(confetti);
        
        setTimeout(() => {
          confetti.style.top = '100%';
          confetti.style.opacity = '1';
          // Reduzir translateX para ¬±50px ao inv√©s de ¬±100px
          confetti.style.transform = `rotate(${Math.random() * 360}deg) translateX(${Math.random() * 100 - 50}px)`;
        }, 50);
        
        setTimeout(() => {
          confetti.remove();
        }, 3000);
      }, i * 100);
    }
  }

})();
</script>
