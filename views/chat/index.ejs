<div class="flex flex-col h-[calc(100vh-8rem)] max-w-4xl mx-auto">
  <!-- Header -->
  <div class="mb-4 text-center">
    <h1 class="text-3xl font-bold">
      <span class="bg-gradient-to-r from-violet-400 via-fuchsia-400 to-pink-400 text-transparent bg-clip-text">
        ðŸ’¬ Chat do Casal
      </span>
    </h1>
    <p class="text-violet-300/80 text-sm mt-2">
      Conversa privada entre <%= couple.partner1_name %> e <%= couple.partner2_name %>
    </p>
  </div>

  <!-- Container de mensagens -->
  <div id="chat-messages" class="flex-1 glass rounded-t-2xl border border-violet-700/40 border-b-0 overflow-y-auto p-4 space-y-3">
    <% if (messages.length === 0) { %>
      <div class="flex items-center justify-center h-full">
        <div class="text-center">
          <svg class="w-16 h-16 mx-auto mb-3 text-violet-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
          </svg>
          <p class="text-violet-300/70 text-sm">Nenhuma mensagem ainda. Comece a conversa!</p>
        </div>
      </div>
    <% } else { %>
      <% messages.forEach(msg => { %>
        <%- include('_message_bubble', { msg, currentUser }) %>
      <% }) %>
    <% } %>
  </div>

  <!-- Input de mensagem -->
  <div class="glass rounded-b-2xl border border-violet-700/40 border-t-0 p-4">
    <form id="chat-form" class="flex gap-3">
      <input
        type="text"
        id="message-input"
        placeholder="Digite sua mensagem..."
        autocomplete="off"
        class="flex-1 px-4 py-3 rounded-lg bg-white/5 border border-violet-700/40 text-violet-100 placeholder-violet-400/50 focus:outline-none focus:ring-2 focus:ring-fuchsia-400/50 focus:border-transparent transition"
      />
      <button
        type="submit"
        class="px-6 py-3 bg-violet-600 hover:bg-violet-700 text-white font-medium rounded-lg transition flex items-center gap-2"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
        </svg>
        <span class="hidden sm:inline">Enviar</span>
      </button>
    </form>
  </div>
</div>

<!-- Socket.IO -->
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
(function() {
  const socket = io();
  const coupleId = <%= couple.id %>;
  const userId = <%= currentUser.id %>;
  const messagesContainer = document.getElementById('chat-messages');
  const messageInput = document.getElementById('message-input');
  const chatForm = document.getElementById('chat-form');

  // Conectar Ã  sala do casal
  socket.emit('join-couple', coupleId);

  // Scroll para o final
  function scrollToBottom() {
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }
  scrollToBottom();

  // Enviar mensagem
  chatForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const message = messageInput.value.trim();
    
    if (!message) return;

    socket.emit('send-message', {
      coupleId,
      userId,
      message
    });

    messageInput.value = '';
  });

  // Receber nova mensagem
  socket.on('new-message', (msg) => {
    // Remover empty state se existir
    const emptyState = messagesContainer.querySelector('.flex.items-center.justify-center');
    if (emptyState) {
      emptyState.remove();
    }

    // Adicionar mensagem
    const isOwn = msg.sender_user_id === userId;
    const messageHtml = createMessageBubble(msg, isOwn);
    messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
    scrollToBottom();
  });

  // Criar bubble de mensagem
  function createMessageBubble(msg, isOwn) {
    const date = new Date(msg.created_at);
    const timeStr = date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
    
    return `
      <div class="flex ${isOwn ? 'justify-end' : 'justify-start'}">
        <div class="max-w-[70%]">
          <div class="${isOwn ? 'bg-violet-600/80' : 'bg-white/5'} rounded-2xl px-4 py-3 border ${isOwn ? 'border-violet-500/40' : 'border-violet-700/40'}">
            ${!isOwn ? `<p class="text-xs text-fuchsia-400 font-medium mb-1">${msg.sender_name}</p>` : ''}
            <p class="text-violet-100 break-words">${escapeHtml(msg.message)}</p>
          </div>
          <p class="text-xs text-violet-400/60 mt-1 ${isOwn ? 'text-right' : 'text-left'}">${timeStr}</p>
        </div>
      </div>
    `;
  }

  // Escape HTML para prevenir XSS
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
})();
</script>
