<style>
  /* Custom scrollbar para chat */
  .scrollbar-thin::-webkit-scrollbar {
    width: 6px;
  }

  .scrollbar-thin::-webkit-scrollbar-track {
    background: rgba(139, 92, 246, 0.1);
    border-radius: 10px;
  }

  .scrollbar-thin::-webkit-scrollbar-thumb {
    background: rgba(139, 92, 246, 0.4);
    border-radius: 10px;
  }

  .scrollbar-thin::-webkit-scrollbar-thumb:hover {
    background: rgba(139, 92, 246, 0.6);
  }
</style>

<div class="flex flex-col h-[calc(100vh-8rem)] max-w-4xl mx-auto">
  <!-- Header -->
  <div class="my-4 text-center">
    <h1 class="text-3xl font-bold">
      <span class="bg-gradient-to-r from-violet-400 via-fuchsia-400 to-pink-400 text-transparent bg-clip-text">
        ðŸ’¬ Chat do Casal
      </span>
    </h1>
    <p class="text-violet-300/80 text-sm mt-2">
      Conversa privada entre <%= couple.partner1_name %> e <%= couple.partner2_name %>
    </p>
  </div>

  <!-- Container de mensagens -->
  <div id="chat-messages" class="flex-1 glass rounded-t-2xl border border-violet-700/40 border-b-0 overflow-y-auto p-4 space-y-3 bg-violet-950/20 scrollbar-thin">
    <% if (messages.length === 0) { %>
      <div class="flex items-center justify-center h-full">
        <div class="text-center">
          <svg class="w-16 h-16 mx-auto mb-3 text-violet-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
          </svg>
          <p class="text-violet-300/70 text-sm">Nenhuma mensagem ainda. Comece a conversa!</p>
        </div>
      </div>
    <% } else { %>
      <% messages.forEach(msg => { %>
        <%- include('_message_bubble', { msg, currentUser }) %>
      <% }) %>
    <% } %>
  </div>

  <!-- Input de mensagem -->
  <div class="glass rounded-b-2xl border border-violet-700/40 border-t-0 p-4">
    <form id="chat-form" class="flex gap-3 my-4">
      <input
        type="file"
        id="photo-input"
        accept="image/jpeg,image/jpg,image/png,image/webp,image/gif"
        class="hidden"
      />
      <button
        type="button"
        id="photo-btn"
        class="px-3 py-3 bg-violet-600/50 hover:bg-violet-600 text-white rounded-lg transition flex items-center gap-2"
        title="Enviar foto"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
        </svg>
      </button>
      <input
        type="text"
        id="message-input"
        placeholder="Digite sua mensagem..."
        autocomplete="off"
  class="flex-1 px-4 py-3 rounded-lg bg-[rgb(0,0,0,0.5)] border border-violet-700/40 text-violet-100 placeholder-violet-400/50 focus:outline-none focus:ring-2 focus:ring-fuchsia-400/50 focus:border-transparent transition"
      />
      <button
        type="submit"
        class="px-6 py-3 bg-violet-600 hover:bg-violet-700 text-white font-medium rounded-lg transition flex items-center gap-2"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
        </svg>
        <span class="hidden sm:inline">Enviar</span>
      </button>
    </form>
    
    <!-- Preview da foto -->
    <div id="photo-preview" class="hidden mt-3 relative">
      <img src="" alt="Preview" class="w-32 h-32 object-cover rounded-lg border border-violet-700/40">
      <button
        type="button"
        id="remove-photo-btn"
        class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center transition"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
  </div>
</div>

<!-- Socket.IO -->
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
(function() {
  const socket = io();
  const coupleId = <%= couple.id %>;
  const userId = <%= currentUser.id %>;
  const messagesContainer = document.getElementById('chat-messages');
  const messageInput = document.getElementById('message-input');
  const chatForm = document.getElementById('chat-form');
  const photoBtn = document.getElementById('photo-btn');
  const photoInput = document.getElementById('photo-input');
  const photoPreview = document.getElementById('photo-preview');
  const removePhotoBtn = document.getElementById('remove-photo-btn');
  let selectedFile = null;

  // Conectar Ã  sala do casal
  socket.emit('join-couple', coupleId);

  // Scroll para o final
  function scrollToBottom(smooth = false) {
    messagesContainer.scrollTo({
      top: messagesContainer.scrollHeight,
      behavior: smooth ? 'smooth' : 'auto'
    });
  }
  
  // Scroll imediato ao carregar
  scrollToBottom();
  
  // Adicionar listeners para todas as imagens no chat
  const chatImages = messagesContainer.querySelectorAll('img');
  let loadedImages = 0;
  const totalImages = chatImages.length;
  
  if (totalImages > 0) {
    chatImages.forEach(img => {
      if (img.complete) {
        loadedImages++;
        if (loadedImages === totalImages) {
          scrollToBottom();
        }
      } else {
        img.addEventListener('load', () => {
          loadedImages++;
          if (loadedImages === totalImages) {
            scrollToBottom();
          }
        });
      }
    });
  }
  
  // Scroll apÃ³s imagens carregarem (fallback)
  window.addEventListener('load', () => {
    scrollToBottom();
  });
  
  // Scroll apÃ³s um pequeno delay para garantir que tudo foi renderizado
  setTimeout(() => {
    scrollToBottom();
  }, 100);
  
  // Mais um scroll depois de 500ms para garantir
  setTimeout(() => {
    scrollToBottom();
  }, 500);

  // BotÃ£o de foto
  photoBtn.addEventListener('click', () => {
    photoInput.click();
  });

  // Preview de foto
  photoInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      selectedFile = file;
      const reader = new FileReader();
      reader.onload = (e) => {
        photoPreview.querySelector('img').src = e.target.result;
        photoPreview.classList.remove('hidden');
      };
      reader.readAsDataURL(file);
    }
  });

  // Remover foto
  removePhotoBtn.addEventListener('click', () => {
    selectedFile = null;
    photoInput.value = '';
    photoPreview.classList.add('hidden');
  });

  // Enviar mensagem ou foto
  chatForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (selectedFile) {
      // Enviar foto
      const formData = new FormData();
      formData.append('photo', selectedFile);
      formData.append('caption', messageInput.value.trim());

      try {
        const response = await fetch('/chat/photo', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();
        if (data.success) {
          // Adicionar a mensagem no chat imediatamente
          const isOwn = data.message.sender_user_id === userId;
          const messageHtml = createMessageBubble(data.message, isOwn);
          
          // Remover empty state se existir
          const emptyState = messagesContainer.querySelector('.flex.items-center.justify-center');
          if (emptyState) {
            emptyState.remove();
          }
          
          messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
          
          // Aguardar imagem carregar e fazer scroll
          const lastImage = messagesContainer.querySelector('img[src="' + data.message.photo_path + '"]');
          if (lastImage) {
            lastImage.addEventListener('load', () => {
              scrollToBottom(true);
            });
            if (lastImage.complete) {
              scrollToBottom(true);
            }
          }
          
          // Limpar formulÃ¡rio
          messageInput.value = '';
          selectedFile = null;
          photoInput.value = '';
          photoPreview.classList.add('hidden');
        }
      } catch (error) {
        console.error('Erro ao enviar foto:', error);
        alert('Erro ao enviar foto');
      }
    } else {
      // Enviar mensagem de texto
      const message = messageInput.value.trim();
      if (!message) return;

      socket.emit('send-message', {
        coupleId,
        userId,
        message
      });

      messageInput.value = '';
    }
  });

  // Receber nova mensagem
  socket.on('new-message', (msg) => {
    // Remover empty state se existir
    const emptyState = messagesContainer.querySelector('.flex.items-center.justify-center');
    if (emptyState) {
      emptyState.remove();
    }

    // Adicionar mensagem
    const isOwn = msg.sender_user_id === userId;
    const messageHtml = createMessageBubble(msg, isOwn);
    messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
    
    // Se a mensagem contÃ©m foto, esperar carregar antes de fazer scroll
    if (msg.message_type === 'photo' && msg.photo_path) {
      const images = messagesContainer.querySelectorAll('img[src="' + msg.photo_path + '"]');
      if (images.length > 0) {
        const lastImage = images[images.length - 1];
        lastImage.addEventListener('load', () => {
          scrollToBottom(true);
        });
        // Fallback caso a imagem jÃ¡ esteja carregada
        if (lastImage.complete) {
          scrollToBottom(true);
        }
      }
    } else {
      scrollToBottom(true);
    }
  });

  // Criar bubble de mensagem
  function createMessageBubble(msg, isOwn) {
    const date = new Date(msg.created_at);
    const timeStr = date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
    
    let content = '';
    if (msg.message_type === 'photo' && msg.photo_path) {
      content = `
        <img src="${msg.photo_path}" alt="Foto" class="max-w-xs rounded-lg cursor-pointer hover:opacity-90 transition" onclick="window.open('${msg.photo_path}', '_blank')">
        ${msg.message ? `<p class="text-violet-100 mt-2 break-words">${escapeHtml(msg.message)}</p>` : ''}
      `;
    } else {
      content = `<p class="text-violet-100 break-words">${escapeHtml(msg.message)}</p>`;
    }
    
    return `
      <div class="flex ${isOwn ? 'justify-end' : 'justify-start'}">
        <div class="max-w-[70%]">
          <div class="${isOwn ? 'bg-violet-600/80' : 'bg-[rgb(0,0,0,0.5)]'} rounded-2xl px-4 py-3 border ${isOwn ? 'border-violet-500/40' : 'border-violet-700/40'}">
            ${!isOwn ? `<p class="text-xs text-fuchsia-400 font-medium mb-1">${msg.sender_name}</p>` : ''}
            ${content}
          </div>
          <p class="text-xs text-violet-400/60 mt-1 ${isOwn ? 'text-right' : 'text-left'}">${timeStr}</p>
        </div>
      </div>
    `;
  }

  // Escape HTML para prevenir XSS
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
})();
</script>
