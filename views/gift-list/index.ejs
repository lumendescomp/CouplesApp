<style>
  /* Custom scrollbar para modais */
  .scrollbar-thin::-webkit-scrollbar {
    width: 8px;
  }
  
  .scrollbar-thin::-webkit-scrollbar-track {
    background: rgba(76, 29, 149, 0.2);
    border-radius: 4px;
  }
  
  .scrollbar-thin::-webkit-scrollbar-thumb {
    background: rgb(124, 58, 237);
    border-radius: 4px;
  }
  
  .scrollbar-thin::-webkit-scrollbar-thumb:hover {
    background: rgb(139, 92, 246);
  }
</style>

<div class="container mx-auto px-2 sm:px-4 py-4 sm:py-8 max-w-7xl">
  <div class="glass rounded-xl sm:rounded-2xl border border-violet-700/30 bg-white/5 p-4 sm:p-6 md:p-8">
    <!-- Header -->
    <div class="mb-8 text-center">
      <h1 class="text-3xl sm:text-4xl font-bold mb-3">
        <span class="bg-gradient-to-r from-violet-400 via-fuchsia-400 to-pink-400 text-transparent bg-clip-text">
          ğŸ Nossa Lista de Presente
        </span>
      </h1>
      <p class="text-violet-300/80 text-sm sm:text-base">
        Adicionem os presentes que vocÃªs desejam ganhar um do outro
      </p>
    </div>

    <!-- Duas colunas para os presentes -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Coluna do Parceiro 1 -->
      <div class="space-y-4">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold text-violet-200 flex items-center gap-2">
            <span class="text-2xl">ğŸ’</span>
            <%= couple.partner1_name %>
          </h2>
          <button 
            class="add-gift-btn px-4 py-2 bg-violet-600 hover:bg-violet-700 text-white text-sm rounded-lg transition flex items-center gap-2"
            data-recipient-id="<%= couple.partner1_id %>"
            data-recipient-name="<%= couple.partner1_name %>"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Adicionar
          </button>
        </div>

        <div class="space-y-3">
          <% if (partner1Gifts.length === 0) { %>
            <div class="glass rounded-lg p-8 text-center">
              <svg class="w-16 h-16 mx-auto mb-3 text-violet-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7" />
              </svg>
              <p class="text-violet-300/70 text-sm">Nenhum presente na lista ainda</p>
            </div>
          <% } else { %>
            <% partner1Gifts.forEach(gift => { %>
              <%- include('_gift_item', { gift, currentUser, couple }) %>
            <% }) %>
          <% } %>
        </div>
      </div>

      <!-- Coluna do Parceiro 2 -->
      <div class="space-y-4">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold text-violet-200 flex items-center gap-2">
            <span class="text-2xl">ğŸ’</span>
            <%= couple.partner2_name %>
          </h2>
          <button 
            class="add-gift-btn px-4 py-2 bg-violet-600 hover:bg-violet-700 text-white text-sm rounded-lg transition flex items-center gap-2"
            data-recipient-id="<%= couple.partner2_id %>"
            data-recipient-name="<%= couple.partner2_name %>"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Adicionar
          </button>
        </div>

        <div class="space-y-3">
          <% if (partner2Gifts.length === 0) { %>
            <div class="glass rounded-lg p-8 text-center">
              <svg class="w-16 h-16 mx-auto mb-3 text-violet-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7" />
              </svg>
              <p class="text-violet-300/70 text-sm">Nenhum presente na lista ainda</p>
            </div>
          <% } else { %>
            <% partner2Gifts.forEach(gift => { %>
              <%- include('_gift_item', { gift, currentUser, couple }) %>
            <% }) %>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modais (fora do container para nÃ£o serem afetados pelo HTMX swap) -->
<%- include('_add_gift_modal', { csrfToken, couple }) %>
<%- include('_edit_gift_modal', { csrfToken }) %>
<%- include('_delete_gift_modal') %>

<script>
(function() {
  // Modais
  const addModal = document.getElementById('add-gift-modal');
  const editModal = document.getElementById('edit-gift-modal');
  const deleteModal = document.getElementById('delete-gift-modal');
  const addForm = document.getElementById('add-gift-form');
  const editForm = document.getElementById('edit-gift-form');
  
  // Estado para deleÃ§Ã£o
  let giftToDelete = null;

  // Abrir modal de adicionar
  document.querySelectorAll('.add-gift-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const recipientId = btn.dataset.recipientId;
      const recipientName = btn.dataset.recipientName;
      
      addModal.querySelector('h3').textContent = `Adicionar presente para ${recipientName}`;
      document.getElementById('gift-recipient-id').value = recipientId;
      addForm.reset();
      document.getElementById('gift-photo-preview').classList.add('hidden');
      addModal.classList.remove('hidden');
    });
  });

  // Fechar modais
  function closeAddModal() {
    addModal.classList.add('hidden');
  }

  function closeEditModal() {
    editModal.classList.add('hidden');
  }

  function closeDeleteModal() {
    deleteModal.classList.add('hidden');
    giftToDelete = null;
  }

  document.querySelectorAll('.close-modal-btn').forEach(btn => {
    btn.addEventListener('click', closeAddModal);
  });

  document.querySelectorAll('.close-edit-modal-btn').forEach(btn => {
    btn.addEventListener('click', closeEditModal);
  });

  // BotÃµes do modal de deleÃ§Ã£o
  document.getElementById('cancel-delete-btn')?.addEventListener('click', closeDeleteModal);
  
  document.getElementById('confirm-delete-btn')?.addEventListener('click', async () => {
    if (giftToDelete) {
      await deleteGift(giftToDelete.id);
      closeDeleteModal();
    }
  });

  addModal?.addEventListener('click', (e) => {
    if (e.target === addModal) closeAddModal();
  });

  editModal?.addEventListener('click', (e) => {
    if (e.target === editModal) closeEditModal();
  });

  deleteModal?.addEventListener('click', (e) => {
    if (e.target === deleteModal) closeDeleteModal();
  });

  // Preview de foto (adicionar)
  document.getElementById('gift-photo-input')?.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const preview = document.getElementById('gift-photo-preview');
        preview.querySelector('img').src = e.target.result;
        preview.classList.remove('hidden');
      };
      reader.readAsDataURL(file);
    }
  });

  // Preview de foto (editar)
  document.getElementById('edit-gift-photo-input')?.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const preview = document.getElementById('edit-gift-photo-preview');
        preview.querySelector('img').src = e.target.result;
        preview.classList.remove('hidden');
      };
      reader.readAsDataURL(file);
    }
  });

  // Submeter novo presente
  addForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    
    try {
      const response = await fetch('/gift-list', {
        method: 'POST',
        body: formData
      });
      
      const data = await response.json();
      
      if (data.success) {
        window.showToast('Presente adicionado com sucesso!');
        closeAddModal();
        setTimeout(() => location.reload(), 500);
      } else {
        throw new Error(data.error || 'Erro ao adicionar presente');
      }
    } catch (error) {
      console.error('Erro:', error);
      window.showToast(error.message || 'Erro ao adicionar presente', 'error');
    }
  });

  // Submeter ediÃ§Ã£o de presente
  editForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const giftId = formData.get('gift_id');
    
    try {
      const response = await fetch(`/gift-list/${giftId}`, {
        method: 'PUT',
        body: formData
      });

      const data = await response.json();
      
      if (data.success) {
        window.showToast('Presente atualizado com sucesso!');
        closeEditModal();
        setTimeout(() => location.reload(), 500);
      } else {
        throw new Error(data.error || 'Erro ao atualizar presente');
      }
    } catch (error) {
      console.error('Erro:', error);
      window.showToast(error.message || 'Erro ao atualizar presente', 'error');
    }
  });

  // DelegaÃ§Ã£o de eventos para cards
  document.addEventListener('click', async (e) => {
    // Editar presente
    const editBtn = e.target.closest('.edit-gift-btn');
    if (editBtn) {
      const giftData = {
        id: editBtn.dataset.giftId,
        name: editBtn.dataset.giftName,
        link: editBtn.dataset.giftLink,
        price: editBtn.dataset.giftPrice,
        photo: editBtn.dataset.giftPhoto
      };
      
      document.getElementById('edit-gift-id').value = giftData.id;
      document.getElementById('edit-gift-name').value = giftData.name;
      document.getElementById('edit-gift-link').value = giftData.link || '';
      document.getElementById('edit-gift-price').value = giftData.price || '';
      
      const currentPhotoDiv = document.getElementById('edit-current-photo-preview');
      const currentPhotoImg = currentPhotoDiv?.querySelector('img');
      if (giftData.photo && currentPhotoImg) {
        currentPhotoImg.src = giftData.photo;
        currentPhotoDiv.classList.remove('hidden');
      } else if (currentPhotoDiv) {
        currentPhotoDiv.classList.add('hidden');
      }
      
      document.getElementById('edit-gift-photo-preview')?.classList.add('hidden');
      const photoInput = document.getElementById('edit-gift-photo-input');
      if (photoInput) photoInput.value = '';
      
      editModal.classList.remove('hidden');
      return;
    }

    // Deletar presente
    const deleteBtn = e.target.closest('.delete-gift-btn');
    if (deleteBtn) {
      // Abre modal de confirmaÃ§Ã£o
      giftToDelete = {
        id: deleteBtn.dataset.giftId,
        name: deleteBtn.dataset.giftName
      };
      
      document.getElementById('delete-gift-name').textContent = giftToDelete.name;
      deleteModal.classList.remove('hidden');
      return;
    }
  });

  async function deleteGift(giftId) {
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
    
    try {
      const response = await fetch(`/gift-list/${giftId}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': csrfToken
        }
      });
      
      const data = await response.json();
      
      if (data.success) {
        window.showToast('Presente removido!');
        setTimeout(() => location.reload(), 500);
      } else {
        throw new Error(data.error || 'Erro ao remover presente');
      }
    } catch (error) {
      console.error('Erro:', error);
      window.showToast(error.message || 'Erro ao remover presente', 'error');
    }
  }
})();
</script>
